name: Preview Cleanup

on:
  pull_request:
    types: [closed]

permissions:
  contents: read

jobs:
  cleanup:
    name: Delete Preview
    runs-on: ubuntu-latest
    steps:
      - name: Delete preview deployment
        uses: actions/github-script@v8
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const projectName = 'dcln';
            const accountId = process.env.CF_ACCOUNT_ID;
            const apiToken = process.env.CF_API_TOKEN;

            if (!accountId || !apiToken) {
              core.warning('Cloudflare secrets not configured â€” skipping preview cleanup');
              return;
            }

            const listUrl = `https://api.cloudflare.com/client/v4/accounts/${accountId}/pages/projects/${projectName}/deployments`;
            const response = await fetch(listUrl, {
              headers: { Authorization: `Bearer ${apiToken}` },
            });
            const data = await response.json();

            if (!data.success) {
              core.warning(`Failed to list deployments: ${JSON.stringify(data.errors)}`);
              return;
            }

            const branchDeployments = data.result.filter(
              (d) => d.deployment_trigger?.metadata?.branch === branch,
            );

            if (branchDeployments.length === 0) {
              core.info(`No deployments found for branch: ${branch}`);
              return;
            }

            for (const deployment of branchDeployments) {
              const deleteUrl = `${listUrl}/${deployment.id}?force=true`;
              const delResponse = await fetch(deleteUrl, {
                method: 'DELETE',
                headers: { Authorization: `Bearer ${apiToken}` },
              });
              const delData = await delResponse.json();
              if (delData.success) {
                core.info(`Deleted deployment ${deployment.id} (${deployment.url})`);
              } else {
                core.warning(`Failed to delete ${deployment.id}: ${JSON.stringify(delData.errors)}`);
              }
            }
